数据库架构设计

 MySQL Schema (关系型数据)

 核心表：
 - users - 用户账户（username, email, password_hash, role, avatar_url）
 - user_profiles - 用户档案（travel_preferences, visited_cities, travel_stats）
 - roles + permissions + role_permissions + user_roles - RBAC权限系统
 - posts - 社交内容（title, content, media_urls, tags, trip_plan_id, moderation_status）
 - comments - 评论（post_id, user_id, parent_id, content）
 - likes - 点赞（user_id, target_type, target_id）
 - follows - 关注关系（follower_id, following_id）
 - tags + post_tags - 标签系统
 - audit_logs - 审计日志

 索引策略：
 - 复合索引：(user_id, status), (user_id, created_at)
 - 全文索引：(posts.title, posts.content)
 - 唯一索引：(username), (email), (follower_id, following_id)

 MongoDB Collections (文档数据)

 核心集合：
 - dialog_sessions - 对话会话
 {
   user_id, session_id, title, context,
   messages: [{role, content, timestamp, metadata}],
   status, created_at, updated_at
 }
 - tool_call_logs - 工具调用日志
 {
   session_id, user_id, tool_name, agent_name,
   input_params, output_result, execution_time_ms,
   status, error_message, created_at
 }
 - travel_plans - 旅行计划
 {
   user_id, session_id, plan_id, city, start_date,
   days: [{attractions, meals, hotel}],
   weather_info, budget, preferences,
   is_favorite, is_completed, created_at
 }

 索引策略：
 - dialog_sessions: {user_id: 1, last_message_at: -1}, {session_id: 1}
 - tool_call_logs: {session_id: 1, created_at: -1}
 - travel_plans: {user_id: 1, created_at: -1}, {plan_id: 1}

 Redis Data Structures

 核心键值：
 - jwt:user:{user_id} (Hash) - JWT Token按设备存储，TTL 7天
 - blacklist:token:{jti} (String) - Token黑名单
 - dialog:session:{session_id} (String-JSON) - 对话缓存，TTL 30分钟
 - dialog:recent:{user_id} (List) - 最近10条消息
 - session:user:{user_id} (Hash) - 用户会话信息
 - rate_limit:{resource}:{user_id} (String) - 限流计数器
 - captcha:{session_id} (String) - 验证码，TTL 5分钟
 - cache:poi:{name} (String-JSON) - POI缓存，TTL 1小时

 API架构设计

 新增路由模块

 /api/auth      - 认证系统（注册、登录、登出、验证码、密码重置）
 /api/user      - 用户管理（个人资料、统计、访问过的城市、修改密码）
 /api/dialog    - 对话系统（多轮对话、会话管理、WebSocket支持）
 /api/plans     - 计划管理（查询、收藏、导出、删除历史计划）
 /api/social    - 社交功能（发帖、点赞、评论、关注、Feed流）
 /api/admin     - 管理后台（用户管理、内容审核、系统监控、日志查询）

 保留现有路由（向后兼容）

 /api/trip      - 旅行规划（增强：认证用户自动保存计划）
 /api/poi       - 景点查询（保持无状态，公开访问）
 /api/map       - 地图服务（保持无状态，公开访问）

 认证中间件设计

 class JWTAuthMiddleware:
     # 必需认证：返回401如果未登录
     # 可选认证：不强制登录，但如已登录则注入用户信息

 async def require_auth(request) -> User:
     # 用于需要登录的端点

 async def optional_auth(request) -> Optional[User]:
     # 用于可选登录的端点（如/api/trip/plan）

 分阶段实施计划

 Phase 1: 数据库基础设施 (Week 1-2)

 关键目标： 建立数据持久化基础，实现用户认证

 任务清单：
 1. 安装数据库依赖
 pip install pymysql sqlalchemy motor pymongo redis pyjwt passlib[bcrypt] captcha Pillow
 2. 创建数据库连接层
   - backend/app/database/__init__.py - 数据库管理器导出
   - backend/app/database/mysql.py - SQLAlchemy引擎和会话工厂
   - backend/app/database/mongodb.py - Motor异步MongoDB客户端
   - backend/app/database/redis_client.py - Redis连接池
 3. 定义SQLAlchemy ORM模型
   - backend/app/database/models.py - 所有MySQL表的ORM映射
   - 使用声明式基类，定义关系和索引
 4. 初始化数据库脚本
   - backend/scripts/init_mysql.sql - MySQL建表脚本
   - backend/scripts/init_mongodb.py - MongoDB集合和索引创建
   - backend/scripts/seed_data.py - 初始化角色权限数据
 5. 更新配置文件
   - 在backend/app/config.py中添加：
       - mysql_host, mysql_port, mysql_user, mysql_password, mysql_database
     - mongodb_uri, mongodb_database
     - redis_url
     - jwt_secret_key, jwt_algorithm, jwt_access_token_expire_days
   - 创建.env.example模板
 6. 实现认证服务
   - backend/app/services/auth_service.py
       - hash_password() - bcrypt密码哈希
     - verify_password() - 密码验证
     - create_access_token() - JWT生成
     - decode_token() - JWT解析
     - generate_captcha() - 验证码生成（使用captcha库）
 7. 创建认证中间件
   - backend/app/middleware/auth_middleware.py
       - 从请求头提取Bearer Token
     - 验证JWT签名和过期时间
     - 检查Redis黑名单
     - 注入request.state.user
 8. 实现认证路由
   - backend/app/api/routes/auth.py
       - POST /api/auth/register - 用户注册
     - POST /api/auth/login - 用户登录
     - POST /api/auth/logout - 登出（Token加入黑名单）
     - POST /api/auth/refresh - 刷新Token
     - GET /api/auth/captcha - 获取验证码
     - POST /api/auth/forgot-password - 忘记密码
     - POST /api/auth/reset-password - 重置密码
 9. 更新主应用
   - 修改backend/app/api/main.py：
       - 在startup_event初始化数据库连接
     - 注册认证路由
     - 增强/health端点检查数据库健康状态

 交付成果： 用户可以注册、登录，JWT Token正常工作

 关键文件：
 - backend/app/database/mysql.py
 - backend/app/services/auth_service.py
 - backend/app/middleware/auth_middleware.py
 - backend/app/api/routes/auth.py
 - backend/app/api/main.py (修改)
 - backend/app/config.py (修改)

 ---
 Phase 2: 旅行计划持久化 (Week 3-4)

 关键目标： 认证用户可以保存和管理旅行计划历史

 任务清单：
 1. 创建计划管理服务
   - backend/app/services/travel_plan_service.py
       - save_plan(user_id, session_id, trip_plan) - 保存到MongoDB
     - get_user_plans(user_id, filters) - 查询用户计划
     - get_plan_by_id(plan_id) - 获取计划详情
     - update_plan(plan_id, updates) - 更新计划
     - mark_favorite(plan_id, is_favorite) - 标记收藏
     - delete_plan(plan_id) - 删除计划
     - _update_user_visited_cities(user_id, city) - 更新MySQL用户档案
 2. 创建计划管理路由
   - backend/app/api/routes/plans.py
       - GET /api/plans - 列出用户计划（支持筛选：city, is_favorite）
     - GET /api/plans/{plan_id} - 获取计划详情
     - PUT /api/plans/{plan_id} - 更新计划
     - POST /api/plans/{plan_id}/favorite - 切换收藏
     - DELETE /api/plans/{plan_id} - 删除计划
     - POST /api/plans/{plan_id}/complete - 标记为已完成
     - GET /api/plans/{plan_id}/export - 导出为PDF/JSON
 3. 创建用户服务
   - backend/app/services/user_service.py
       - get_user_profile(user_id) - 获取用户资料
     - update_user_profile(user_id, updates) - 更新资料
     - get_user_stats(user_id) - 统计数据（从MongoDB聚合）
     - get_visited_cities(user_id) - 访问过的城市列表
     - change_password(user_id, old_password, new_password) - 修改密码
 4. 创建用户管理路由
   - backend/app/api/routes/user.py
       - GET /api/user/profile - 获取当前用户资料
     - PUT /api/user/profile - 更新资料
     - POST /api/user/avatar - 上传头像
     - GET /api/user/stats - 获取旅行统计
     - GET /api/user/visited-cities - 获取访问过的城市
     - POST /api/user/change-password - 修改密码
 5. 增强现有旅行规划路由
   - 修改backend/app/api/routes/trip.py的/api/trip/plan：
       - 使用optional_auth中间件（可选认证）
     - 如果用户已登录：
           - 创建对话会话（为Phase 3准备）
       - 保存计划到MongoDB
       - 更新用户visited_cities
       - 返回plan_id
     - 如果匿名用户：
           - 保持原有行为（仅返回计划，不保存）
 6. 实现文件上传服务
   - backend/app/services/storage_service.py
       - upload_avatar(file, user_id) - 保存头像到本地或OSS
     - get_file_url(file_path) - 获取文件访问URL

 交付成果： 认证用户的旅行计划自动保存，可查询历史记录，匿名用户保持原有体验

 关键文件：
 - backend/app/services/travel_plan_service.py
 - backend/app/services/user_service.py
 - backend/app/api/routes/plans.py
 - backend/app/api/routes/user.py
 - backend/app/api/routes/trip.py (修改)

 ---
 Phase 3: 对话式AI系统 (Week 5-6)

 关键目标： 实现多轮对话能力，支持上下文理解和工具调用日志

 任务清单：
 1. 创建对话管理服务
   - backend/app/services/dialog_service.py
       - create_session(user_id) - 创建新对话会话
     - add_message(session_id, role, content, metadata) - 添加消息
     - get_session_context(session_id) - 获取会话上下文
     - log_tool_call(...) - 记录工具调用到MongoDB
     - list_user_sessions(user_id) - 列出用户会话
     - delete_session(session_id) - 删除会话
     - 同时更新MongoDB（持久化）和Redis（缓存）
 2. 扩展多智能体系统
   - 修改backend/app/agents/trip_planner_agent.py：
       - 创建ConversationalMultiAgentTripPlanner类继承MultiAgentTripPlanner
     - 添加__init__(self, dialog_service)构造函数
     - 实现async chat(session_id, user_id, user_message)方法：
           - 获取会话上下文
       - 意图识别（_detect_intent）
       - 路由到对应处理器：
               - _handle_trip_planning - 生成旅行计划
         - _handle_info_query - 查询景点/天气/酒店信息
         - _handle_plan_modification - 修改已有计划
       - 记录工具调用日志
       - 保存对话消息
     - 在每次工具调用后调用dialog_service.log_tool_call()
 3. 实现对话路由
   - backend/app/api/routes/dialog.py
       - POST /api/dialog/chat - 多轮对话接口
           - 请求：{session_id?, message, voice_data?}
       - 响应：{session_id, message, intent, suggestions}
     - GET /api/dialog/sessions - 列出对话会话
     - GET /api/dialog/sessions/{session_id} - 获取会话历史
     - DELETE /api/dialog/sessions/{session_id} - 删除会话
     - WebSocket /api/dialog/ws/{session_id} - WebSocket实时对话
 4. 实现WebSocket支持
   - 修改backend/app/api/routes/dialog.py：
       - 添加WebSocket端点/api/dialog/ws/{session_id}
     - 支持双向通信（客户端发送消息，服务端流式返回）
     - 连接管理（心跳、断线重连）
 5. 实现语音输入服务（可选）
   - backend/app/services/voice_service.py
       - transcribe(audio_data) - 语音转文字
     - 选项1：OpenAI Whisper API
     - 选项2：本地Whisper模型
     - 选项3：Azure Speech Services
 6. 工具调用日志可视化准备
   - 确保所有Agent工具调用都记录到MongoDB
   - 记录字段：tool_name, input_params, output_result, execution_time_ms, status

 交付成果： 用户可以进行多轮对话，系统理解上下文，工具调用被完整记录

 关键文件：
 - backend/app/services/dialog_service.py
 - backend/app/agents/trip_planner_agent.py (扩展)
 - backend/app/api/routes/dialog.py
 - backend/app/services/voice_service.py (可选)

 ---
 Phase 4: 社交功能 (Week 7-8)

 关键目标： 用户可以分享旅行内容，点赞评论关注

 任务清单：
 1. 创建社交服务
   - backend/app/services/social_service.py
       - create_post(user_id, title, content, media_urls, tags, location, trip_plan_id)
     - moderate_content(content) - 内容审核（关键词过滤）
     - get_feed(user_id, limit, offset) - 个性化Feed流
     - like_post(user_id, post_id) - 点赞/取消点赞
     - comment_on_post(user_id, post_id, content, parent_id) - 发表评论
     - follow_user(follower_id, following_id) - 关注用户
     - get_user_posts(user_id) - 获取用户发布的内容
     - get_popular_tags() - 获取热门标签
 2. 创建社交路由
   - backend/app/api/routes/social.py
       - POST /api/social/posts - 创建帖子
     - POST /api/social/posts/media - 上传媒体文件
     - GET /api/social/posts - 获取Feed流（个性化）
     - GET /api/social/posts/{post_id} - 获取帖子详情
     - POST /api/social/posts/{post_id}/like - 点赞/取消
     - POST /api/social/posts/{post_id}/comments - 发表评论
     - GET /api/social/posts/{post_id}/comments - 获取评论列表
     - POST /api/social/users/{user_id}/follow - 关注/取消关注
     - GET /api/social/users/{user_id}/posts - 用户主页帖子
     - GET /api/social/tags - 热门标签
     - GET /api/social/tags/{tag_name}/posts - 按标签查询
 3. 实现内容审核
   - 在social_service.py中实现moderate_content()
   - 关键词黑名单过滤
   - 可选：集成第三方内容审核API
   - 审核状态：pending, approved, rejected
 4. 实现媒体文件处理
   - 扩展backend/app/services/storage_service.py：
       - upload_media(file, user_id) - 保存图片/视频
     - generate_thumbnail(image_path) - 生成缩略图
     - 支持多文件上传
     - 文件类型验证（JPEG, PNG, MP4等）
     - 大小限制（图片5MB，视频50MB）
 5. 实现Feed流算法
   - 混合策略：
       - 50% 关注用户的最新内容
     - 30% 热门内容（点赞数高）
     - 20% 推荐内容（基于用户偏好）
   - 时间衰减：新内容优先
   - 分页加载

 交付成果： 用户可以分享旅行经历，浏览Feed流，点赞评论关注

 关键文件：
 - backend/app/services/social_service.py
 - backend/app/api/routes/social.py
 - backend/app/services/storage_service.py (扩展)

 ---
 Phase 5: 管理后台与系统监控 (Week 9-10)

 关键目标： 管理员可以管理用户、审核内容、监控系统

 任务清单：
 1. 创建管理服务
   - backend/app/services/admin_service.py
       - list_users(filters, pagination) - 用户列表
     - update_user_status(user_id, is_active) - 激活/禁用用户
     - get_posts_for_moderation(status) - 待审核内容
     - moderate_post(post_id, status, reason) - 审核通过/拒绝
     - get_system_stats() - 系统统计数据
     - get_audit_logs(filters) - 审计日志
     - get_tool_call_stats() - 工具调用统计
 2. 创建监控服务
   - backend/app/services/monitoring_service.py
       - check_database_health() - 数据库健康检查
     - check_redis_health() - Redis健康检查
     - check_agent_health() - Agent响应检查
     - get_performance_metrics() - 性能指标
           - 平均响应时间
       - 请求速率
       - 错误率
       - 缓存命中率
 3. 创建管理路由
   - backend/app/api/routes/admin.py
       - GET /api/admin/users - 用户列表（需要admin角色）
     - PUT /api/admin/users/{user_id}/status - 激活/禁用用户
     - GET /api/admin/posts/moderation - 待审核内容
     - PUT /api/admin/posts/{post_id}/moderate - 审核内容
     - GET /api/admin/stats - 系统统计
     - GET /api/admin/logs/audit - 审计日志
     - GET /api/admin/logs/tools - 工具调用日志
     - POST /api/admin/backup/mysql - 触发MySQL备份
     - POST /api/admin/backup/mongodb - 触发MongoDB备份
     - GET /api/admin/config - 获取系统配置
     - PUT /api/admin/config - 更新配置
 4. 实现审计日志
   - 创建audit_logger装饰器：
       - 记录所有写操作（POST, PUT, DELETE）
     - 记录用户ID、操作、资源、IP地址、User-Agent
     - 存储到MySQL audit_logs表
 5. 实现备份脚本
   - backend/scripts/backup_mysql.sh
       - mysqldump全量备份
     - 保留30天
   - backend/scripts/backup_mongodb.sh
       - mongodump备份
     - 保留30天
   - 定时任务配置（cron）
 6. 实现系统监控
   - 增强/health端点：
       - 检查MySQL/MongoDB/Redis连接
     - 检查磁盘空间
     - 检查Agent响应时间
   - 添加/metrics端点（Prometheus格式，可选）

 交付成果： 完整的管理后台，系统监控和备份机制

 关键文件：
 - backend/app/services/admin_service.py
 - backend/app/services/monitoring_service.py
 - backend/app/api/routes/admin.py
 - backend/scripts/backup_mysql.sh
 - backend/scripts/backup_mongodb.sh

 ---
 Phase 6: 前端集成 (Week 11-12)

 关键目标： 完整的前端用户体验

 任务清单：
 1. 安装前端依赖
 npm install pinia @ant-design/icons-vue dayjs echarts vue-echarts
 2. 创建状态管理Store
   - frontend/src/stores/auth.ts - 认证状态（user, token, isAuthenticated）
   - frontend/src/stores/dialog.ts - 对话状态（sessions, currentSession, messages）
   - frontend/src/stores/plans.ts - 计划状态（userPlans, currentPlan）
   - frontend/src/stores/social.ts - 社交状态（feed, userProfile）
 3. 创建API服务层
   - frontend/src/services/auth.ts - 认证API
   - frontend/src/services/dialog.ts - 对话API + WebSocket
   - frontend/src/services/plans.ts - 计划管理API
   - frontend/src/services/social.ts - 社交API
   - frontend/src/services/user.ts - 用户API
 4. 更新路由配置
   - 修改frontend/src/router/index.ts：
       - 添加路由：/login, /register, /chat, /plans, /plans/:id, /social, /profile, /admin
     - 实现路由守卫：
           - requiresAuth - 检查登录状态
       - requiresRole - 检查角色权限
     - 未登录重定向到/login
 5. 创建认证页面
   - frontend/src/views/Login.vue - 登录页面
   - frontend/src/views/Register.vue - 注册页面
   - frontend/src/components/auth/LoginForm.vue - 登录表单
   - frontend/src/components/auth/RegisterForm.vue - 注册表单
   - frontend/src/components/auth/CaptchaInput.vue - 验证码输入
 6. 创建对话页面
   - frontend/src/views/Chat.vue - 对话主页
   - frontend/src/components/dialog/ChatWindow.vue - 聊天窗口
   - frontend/src/components/dialog/MessageBubble.vue - 消息气泡
   - frontend/src/components/dialog/VoiceInput.vue - 语音输入
   - frontend/src/components/dialog/SessionList.vue - 会话列表
 7. 创建计划管理页面
   - frontend/src/views/Plans.vue - 计划列表
   - frontend/src/views/PlanDetail.vue - 计划详情
   - frontend/src/components/plans/PlanCard.vue - 计划卡片
   - frontend/src/components/plans/PlanTimeline.vue - 行程时间线
   - frontend/src/components/plans/PlanMap.vue - 地图展示
 8. 创建社交页面
   - frontend/src/views/Social.vue - 社交Feed流
   - frontend/src/components/social/PostCard.vue - 帖子卡片
   - frontend/src/components/social/PostEditor.vue - 发帖编辑器
   - frontend/src/components/social/CommentList.vue - 评论列表
   - frontend/src/components/social/UserCard.vue - 用户卡片
 9. 创建个人中心页面
   - frontend/src/views/Profile.vue - 个人中心主页
   - frontend/src/components/profile/ProfileCard.vue - 用户资料卡
   - frontend/src/components/profile/VisitedCitiesMap.vue - 访问城市地图（高德地图）
   - frontend/src/components/profile/TravelStats.vue - 旅行统计（ECharts）
 10. 创建管理后台页面
   - frontend/src/views/Admin.vue - 管理后台
   - 用户管理、内容审核、系统监控模块
 11. 增强现有Home页面
   - 修改frontend/src/views/Home.vue：
       - 添加登录/注册入口
     - 如果已登录，显示用户头像和快捷菜单
     - 保持原有旅行规划表单功能
 12. 实现Axios拦截器
   - 修改frontend/src/services/api.ts：
       - 请求拦截器：自动添加Authorization: Bearer {token}
     - 响应拦截器：
           - 401错误 → 清除Token，跳转登录
       - Token即将过期 → 自动刷新

 交付成果： 完整的前端应用，所有功能可用

 关键文件：
 - frontend/src/stores/ (新建4个Store)
 - frontend/src/services/ (新建5个服务)
 - frontend/src/views/ (新建8个页面)
 - frontend/src/components/ (新建20+个组件)
 - frontend/src/router/index.ts (修改)

 ---
 Phase 7: 测试与优化 (Week 13-14)

 关键目标： 系统稳定、性能优化、安全加固

 任务清单：
 1. 单元测试
   - 后端：使用pytest测试关键服务和路由
   - 前端：使用Vitest测试组件和Store
 2. 集成测试
   - API端到端测试
   - 认证流程测试
   - 对话系统测试
   - 社交功能测试
 3. 性能优化
   - 数据库查询优化（添加缺失的索引）
   - Redis缓存策略调整
   - 前端懒加载和代码分割
   - 图片压缩和CDN集成
 4. 安全加固
   - SQL注入防护验证
   - XSS防护验证
   - CSRF Token（可选）
   - Rate Limiting测试
   - 密码策略加强
 5. 文档编写
   - API文档完善（Swagger增强）
   - 部署文档
   - 运维手册
   - 用户手册
 6. 部署准备
   - Docker容器化
   - docker-compose配置
   - 环境变量管理
   - 日志收集配置

 交付成果： 生产就绪的系统

 ---
 关键技术决策与权衡

 1. 混合式数据库架构

 决策： MySQL + MongoDB + Redis三层架构
 - 优势： 各司其职，性能最优（MySQL处理关系型数据，MongoDB处理文档和对话，Redis处理缓存和会话）
 - 劣势： 运维复杂度增加，数据一致性需要手动管理
 - 缓解： 使用事务（MySQL）和幂等操作（MongoDB），Redis仅作缓存失败不影响核心功能

 2. 可选认证策略

 决策： /api/trip/plan支持可选认证（既可匿名也可登录使用）
 - 优势： 降低使用门槛，用户可先试用再注册，提升转化率
 - 劣势： 代码复杂度增加，需要双路径处理
 - 缓解： 使用optional_auth中间件统一处理，核心逻辑保持一致

 3. JWT存储在Redis

 决策： JWT Token存储在Redis而非数据库
 - 优势： 极快的验证速度（<1ms），自动过期，支持黑名单
 - 劣势： Redis故障会导致所有用户登出
 - 缓解： Redis持久化（RDB+AOF），主从复制保证高可用

 4. 对话历史两层存储

 决策： Redis缓存最近对话（30分钟），MongoDB持久化完整历史
 - 优势： 快速访问频繁使用的数据，同时保留长期历史
 - 劣势： 缓存和数据库需同步更新
 - 缓解： 写入时同时更新两者，读取时优先Redis，失败后回退MongoDB

 5. 工具调用日志到MongoDB

 决策： 所有Agent工具调用记录到MongoDB而非MySQL
 - 优势： 灵活的JSON结构，无需预定义schema，适合调试和分析
 - 劣势： 查询和统计不如关系型数据库方便
 - 缓解： 创建合理的索引，使用聚合管道进行复杂查询

 6. 社交数据在MySQL

 决策： 帖子、评论、点赞等关系型数据存储在MySQL
 - 优势： ACID事务保证数据一致性，JOIN查询高效
 - 劣势： 大规模时扩展性受限
 - 缓解： 合理索引，读写分离，热点数据Redis缓存

 ---
 性能优化策略

 缓存层次

 1. L1 缓存（Redis）： 用户会话、最近对话、热门帖子、POI信息
 2. L2 持久化（MongoDB/MySQL）： 完整数据存储
 3. 缓存失效策略： LRU淘汰，TTL自动过期

 数据库索引

 - MySQL：复合索引 (user_id, created_at DESC)，全文索引 (title, content)
 - MongoDB：复合索引 {user_id: 1, last_message_at: -1}

 连接池

 - MySQL：Pool size 20, max overflow 40
 - MongoDB：Motor默认连接池
 - Redis：50个连接

 限流策略

 - 全局限流：60 req/min per IP
 - 用户限流：100 req/min per user
 - 特殊端点：登录5次/5分钟，验证码10次/小时

 ---
 安全措施

 1. 认证安全： bcrypt哈希（cost=12），JWT短期过期（7天），多设备支持
 2. 输入验证： Pydantic模型强验证，SQL注入防护（ORM），XSS防护
 3. 访问控制： RBAC权限系统，资源级别权限检查
 4. 审计日志： 所有敏感操作记录到audit_logs表
 5. 限流保护： Redis计数器，滑动窗口算法
 6. 内容审核： 关键词过滤，人工复审机制

 ---
 监控与日志

 应用日志

 - Loguru结构化日志，分级别（DEBUG/INFO/WARNING/ERROR）
 - 按模块分文件：auth.log, dialog.log, social.log

 业务指标

 - 用户注册/登录速率
 - 旅行计划生成成功率
 - 工具调用成功率和响应时间
 - 社交互动数据（发帖、点赞、评论数）

 系统健康

 - 数据库连接池使用率
 - Redis内存使用率
 - API响应时间（P50, P95, P99）
 - 错误率

 ---
 备份与灾难恢复

 1. MySQL备份： 每日全量备份 + binlog增量，保留30天
 2. MongoDB备份： 每日mongodump + oplog增量，保留30天
 3. Redis持久化： RDB每5分钟 + AOF，主从复制
 4. 媒体文件： 定期备份到对象存储（OSS/S3）