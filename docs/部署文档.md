# 旅行代理系统生产环境部署文档

## 1. 项目概述

本项目是一个基于Vue 3和FastAPI的旅行代理系统，包含前端和后端两部分。前端负责用户界面展示，后端负责业务逻辑处理，使用MySQL、MongoDB和Redis作为数据存储和缓存。

## 2. 技术栈

| 组件 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 前端 | Vue 3 | ^3.5.13 | 前端框架 |
| 后端 | FastAPI | ^0.115.0 | 后端API框架 |
| 数据库 | MySQL | 8.0 | 关系型数据库 |
| 数据库 | MongoDB | 7.0 | 文档型数据库 |
| 缓存 | Redis | 7.0+ | 缓存和消息队列 |
| 反向代理 | Nginx | 1.25+ | 负载均衡和静态文件服务 |
| 容器化 | Docker | 20.10+ | 应用容器化 |
| 容器编排 | Docker Compose | 2.20+ | 多容器管理 |

## 3. 部署架构

```
┌───────────────────────────────────────────────────────────────────┐
│                           外部网络                               │
└───────────────────────┬───────────────────────────────────────────┘
                        │
┌───────────────────────▼───────────────────────────────────────────┐
│                          Nginx 负载均衡                          │
├───────────────────────┬───────────────────────────────────────────┤
│                      ┌┴┐                                         │
│                      │ │                                         │
└───────────────────────┼┼──────────────────────────────────────────┘
                        ││
┌───────────────────────▼▼──────────────────────────────────────────┐
│               前端应用 (Vue 3 打包静态文件)                      │
└───────────────────────┬───────────────────────────────────────────┘
                        │
┌───────────────────────▼───────────────────────────────────────────┐
│                          后端应用 (FastAPI)                      │
├───────────────────────┬───────────────────────────────────────────┤
│                      ┌┴┐                                         │
│                      │ │                                         │
└───────────────────────┼┼──────────────────────────────────────────┘
                        ││
┌───────────────────────▼▼──────────────────────────────────────────┐
│                           数据存储层                             │
├─────────────────┬──────────────┬───────────────────────────────────┤
│                 │              │                                 │
┌─────────────────▼┐  ┌──────────▼┐  ┌─────────────────────────────┐
│    MySQL 8.0    │  │ MongoDB 7.0│  │         Redis 7.0+         │
└─────────────────┘  └────────────┘  └─────────────────────────────┘
```

## 4. 部署前准备

### 4.1 环境要求

- Docker 20.10+ 
- Docker Compose 2.20+ 
- Git
- 服务器至少4GB内存，2核CPU
- 操作系统：Ubuntu 20.04+ 或 CentOS 7+ 

### 4.2 资源准备

- 服务器（云服务器或物理服务器）
- 域名（可选，用于配置HTTPS）
- SSL证书（可选，用于配置HTTPS）

## 5. 部署步骤

### 5.1 克隆代码

```bash
# 克隆代码仓库
git clone https://github.com/yourusername/travel-agent.git
cd travel-agent
```

### 5.2 创建Docker配置文件

#### 5.2.1 创建Dockerfile（前端）

在 `frontend` 目录下创建 `Dockerfile` 文件：

```dockerfile
# 前端构建镜像
FROM node:18-alpine as build

WORKDIR /app

# 复制依赖文件
COPY package*.json ./

# 安装依赖
RUN npm install

# 复制源码
COPY .. .

# 构建生产版本
RUN npm run build

# Nginx镜像
FROM nginx:1.25-alpine

# 复制构建产物到Nginx
COPY --from=build /app/dist /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 暴露端口
EXPOSE 80

# 启动Nginx
CMD ["nginx", "-g", "daemon off;"]
```

#### 5.2.2 创建Dockerfile（后端）

在 `backend` 目录下创建 `Dockerfile` 文件：

```dockerfile
# 后端镜像
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libc-dev \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制源码
COPY . .

# 暴露端口
EXPOSE 8000

# 启动应用
CMD ["python", "run.py"]
```

#### 5.2.3 创建nginx.conf文件

在 `frontend` 目录下创建 `nginx.conf` 文件：

```nginx
server {
    listen 80;
    server_name localhost;

    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SSE支持
    location /api/dialog/sse {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```

#### 5.2.4 创建docker-compose.yml文件

在项目根目录下创建 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: always

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    depends_on:
      - mysql
      - mongodb
      - redis
    environment:
      - HOST=0.0.0.0
      - PORT=8000
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=123456
      - MYSQL_DATABASE=travel_agent
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=test
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=123456
      - REDIS_DB=1
      - JWT_SECRET_KEY=UoFj5OGotDPJFlQLFTHQDZtB7QDtR3lG01Xk+iDVnY4=
    restart: always

  # MySQL数据库
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=123456
      - MYSQL_DATABASE=travel_agent
    volumes:
      - mysql-data:/var/lib/mysql
      - ./backend/scripts/init_mysql.sql:/docker-entrypoint-initdb.d/init.sql
    restart: always

  # MongoDB数据库
  mongodb:
    image: mongo:7.0
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    restart: always

  # Redis缓存
  redis:
    image: redis:7.0
    ports:
      - "6379:6379"
    command: redis-server --requirepass 123456
    volumes:
      - redis-data:/data
    restart: always

volumes:
  mysql-data:
  mongo-data:
  redis-data:
```

### 5.3 创建环境配置文件

在 `backend` 目录下创建 `.env` 文件：

```env
# LLM配置
LLM_MODEL_ID="Qwen/Qwen2.5-72B-Instruct"
LLM_API_KEY=API_KEY
LLM_BASE_URL="https://api-inference.modelscope.cn/v1/"
LLM_TIMEOUT=60

# 服务器配置
HOST=0.0.0.0
PORT=8000

# CORS配置
CORS_ORIGINS=http://localhost,http://localhost:80

# 日志级别
LOG_LEVEL=INFO

# Unsplash API Credentials
UNSPLASH_ACCESS_KEY="QuvNEksG7496IMigS5BhLkbiZg5MrFkszr35xutStEE"
UNSPLASH_SECRET_KEY=API_KEY

# 高德地图API配置
AMAP_API_KEY=API_KEY

# 数据库配置
MYSQL_HOST=mysql
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=123456
MYSQL_DATABASE=travel_agent

MONGODB_HOST=mongodb
MONGODB_PORT=27017
MONGODB_USER=
MONGODB_PASSWORD=
MONGODB_DATABASE=test

REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=123456
REDIS_DB=1

# JWT认证配置
JWT_SECRET_KEY=UoFj5OGotDPJFlQLFTHQDZtB7QDtR3lG01Xk+iDVnY4=
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_DAYS=7

# 安全配置
PASSWORD_MIN_LENGTH=8
CAPTCHA_EXPIRY_SECONDS=300
MAX_LOGIN_ATTEMPTS=5

# 限流配置
RATE_LIMIT_PER_MINUTE=60

# OSS云存储配置
OSS_ENABLED=true
OSS_ACCESS_KEY_ID=LTAI5tChzi1g1csczkKBbec9
OSS_ACCESS_KEY_SECRET=API_KEY
OSS_ENDPOINT=oss-cn-beijing.aliyuncs.com
OSS_BUCKET_NAME=java-webai-1
OSS_AVATAR_DIR=travel_avatars
OSS_MEDIA_DIR=travel_media
```

### 5.4 构建和启动服务

```bash
# 构建并启动所有服务
docker-compose up -d --build

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f
```

### 5.5 初始化数据

```bash
# 进入后端容器
docker exec -it travel-agent-backend-1 bash

# 运行初始化脚本
python scripts/init_mongodb.py

# 退出容器
exit
```

## 6. 配置说明

### 6.1 前端配置

- **Nginx配置**：`frontend/nginx.conf` 文件配置了前端静态文件服务和API代理。
- **API地址**：前端通过Nginx代理访问后端API，无需在前端代码中硬编码API地址。

### 6.2 后端配置

- **环境变量**：后端通过 `.env` 文件配置环境变量，包括数据库连接、API密钥等。
- **数据库配置**：后端连接MySQL、MongoDB和Redis，配置在 `.env` 文件中。

### 6.3 数据库配置

- **MySQL**：使用官方MySQL 8.0镜像，通过环境变量配置root密码和数据库名称。
- **MongoDB**：使用官方MongoDB 7.0镜像，默认配置。
- **Redis**：使用官方Redis 7.0镜像，通过命令行参数配置密码。

## 7. 测试与验证

### 7.1 服务状态检查

```bash
# 检查所有服务是否正常运行
docker-compose ps

# 检查前端服务
curl http://localhost

# 检查后端API
curl http://localhost/api/health
```

### 7.2 功能测试

1. **访问前端页面**：在浏览器中访问 `http://服务器IP`，应该能看到前端页面。
2. **注册用户**：测试用户注册功能。
3. **登录系统**：测试用户登录功能。
4. **创建旅行计划**：测试旅行计划创建功能。
5. **智能对话**：测试智能对话功能，验证SSE实时推送。

## 8. 监控与维护

### 8.1 日志管理

```bash
# 查看前端日志
docker-compose logs frontend

# 查看后端日志
docker-compose logs backend

# 查看数据库日志
docker-compose logs mysql
```

### 8.2 数据备份

```bash
# 备份MySQL数据
docker exec -it travel-agent-mysql-1 mysqldump -u root -p123456 travel_agent > backup.sql

# 备份MongoDB数据
docker exec -it travel-agent-mongodb-1 mongodump --db test --out /backup

docker cp travel-agent-mongodb-1:/backup ./backup
```

### 8.3 服务更新

```bash
# 停止并删除旧服务
docker-compose down

# 拉取最新代码
git pull

# 重新构建并启动服务
docker-compose up -d --build
```

### 8.4 常见问题排查

1. **服务启动失败**：检查Docker日志，查看具体错误信息。
2. **数据库连接失败**：检查数据库服务是否正常运行，检查连接配置。
3. **API访问失败**：检查后端服务是否正常运行，检查Nginx代理配置。
4. **前端页面无法访问**：检查前端服务是否正常运行，检查Nginx配置。

## 9. 性能优化

### 9.1 Nginx优化

- **启用gzip压缩**：减少传输数据量。
- **配置缓存**：缓存静态资源，减少服务器负载。
- **调整worker进程数**：根据服务器CPU核心数调整。

### 9.2 后端优化

- **启用Gunicorn**：使用Gunicorn作为WSGI服务器，支持多进程。
- **配置连接池**：优化数据库连接池配置。
- **使用Redis缓存**：缓存热点数据，减少数据库查询。

### 9.3 前端优化

- **代码分割**：使用Vue的代码分割功能，减少初始加载时间。
- **图片优化**：压缩图片，使用适当的图片格式。
- **资源缓存**：配置浏览器缓存策略。

## 10. 安全配置

### 10.1 Nginx安全配置

- **配置HTTPS**：使用SSL证书，启用HTTPS。
- **限制访问**：配置IP访问限制，防止恶意访问。
- **隐藏版本信息**：隐藏Nginx版本信息，减少攻击面。

### 10.2 后端安全配置

- **使用HTTPS**：配置后端服务使用HTTPS。
- **CORS配置**：正确配置CORS，防止跨站请求伪造。
- **输入验证**：对所有用户输入进行验证，防止注入攻击。
- **密码加密**：使用bcrypt等安全的密码哈希算法。

### 10.3 数据库安全配置

- **使用非root用户**：为数据库创建专用用户，限制权限。
- **密码策略**：使用强密码，定期更换。
- **数据加密**：对敏感数据进行加密存储。

## 11. 扩展方案

### 11.1 水平扩展

- **前端扩展**：增加Nginx实例，使用负载均衡器分发请求。
- **后端扩展**：增加后端服务实例，使用负载均衡器分发请求。
- **数据库扩展**：使用主从复制，读写分离。

### 11.2 垂直扩展

- **增加服务器资源**：增加服务器内存、CPU等资源。
- **优化数据库**：配置数据库参数，提高性能。
- **使用缓存**：增加Redis缓存，减少数据库压力。

## 12. 总结

本部署文档详细描述了旅行代理系统的生产环境部署方案，包括：

1. **容器化部署**：使用Docker和Docker Compose实现容器化部署，简化部署流程。
2. **多容器管理**：使用Docker Compose管理多个容器，包括前端、后端、MySQL、MongoDB和Redis。
3. **负载均衡**：使用Nginx实现前端静态文件服务和API代理，支持负载均衡。
4. **实时推送**：配置Nginx支持SSE实时推送，确保智能对话功能正常运行。
5. **数据存储**：使用MySQL、MongoDB和Redis作为数据存储和缓存，满足不同数据类型的存储需求。
6. **安全配置**：提供了安全配置建议，确保系统安全运行。
7. **监控与维护**：提供了监控和维护方案，确保系统稳定运行。

通过本部署方案，旅行代理系统可以在生产环境中稳定运行，为用户提供良好的服务体验。